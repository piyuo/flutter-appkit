# .github/workflows/auto-merge-to-develop.yml
name: Auto Merge Main to Develop

# Trigger this workflow when there are pushes to main branch
on:
    push:
        branches:
            - main

jobs:
    auto-merge:
        runs-on: ubuntu-latest

        steps:
            # Checkout the repository with full history to enable merging
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  # Fetch full history for all branches to enable proper merging
                  fetch-depth: 0
                  # Use a token that has permission to push to protected branches
                  token: ${{ secrets.GITHUB_TOKEN }}

            # Configure Git user for the merge commit
            - name: Configure Git
              run: |
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"

            # Switch to develop branch and merge main branch into it
            - name: Merge main into develop
              run: |
                  # Switch to develop branch
                  git checkout develop

                  # Pull latest changes from develop to avoid conflicts
                  git pull origin develop

                  # Merge main branch into develop
                  # Using --no-ff to create a merge commit for better tracking
                  git merge origin/main --no-ff -m "Auto-merge main into develop after release"

                  # Push the merged changes back to develop branch
                  git push origin develop
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            # Optional: Create a comment or notification about the successful merge
            - name: Create success comment
              if: success()
              run: |
                  echo "✅ Successfully merged main branch into develop branch"

            # Handle merge conflicts or failures
            - name: Handle merge failure
              if: failure()
              run: |
                  echo "❌ Failed to merge main into develop. Manual intervention required."
                  echo "This could be due to merge conflicts or other issues."
