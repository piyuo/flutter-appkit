  amap_flutter_map: ^3.0.0 # 高德地圖

import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:amap_flutter_map/amap_flutter_map.dart';
import 'package:amap_flutter_base/amap_flutter_base.dart';
import 'package:libcli/general/general.dart' as general;
import 'map.dart';

/// AmapImpl is amap implementation
class AmapImpl extends MapProviderImpl {
  AMapController? _controller;

  final Set<Marker> _markers = {};

  @override
  Future<void> setValue(general.LatLng latlng, bool showMarker) async {
    await super.setValue(latlng, showMarker);
    resetMarker();

    if (_controller != null) {
      _controller!.moveCamera(
        CameraUpdate.newCameraPosition(
          CameraPosition(
            target: LatLng(latlng.lat, latlng.lng),
            zoom: 18,
          ),
        ),
      );
    }
  }

  /// resetMarker reset marker position
  void resetMarker() {
    _markers.clear();
    if (showMarker) {
      _markers.add(
        Marker(
            infoWindowEnable: false,
            position: LatLng(
              latlng.lat,
              latlng.lng,
            )),
      );
    }
  }
}

/// AMapApiKey is amap.com key, you need generate android key
///  here is how to get sha1 for amap android key
/// https://stackoverflow.com/questions/15727912/sha-1-fingerprint-of-keystore-certificate
///
/// in android/app/src/build.gradle
/// add implementation 'com.amap.api:3d map:latest.integration'
///
/// android/app/src/main/AndroidManifest.xml
/// <manifest ...
///   <application ...
///     <meta-data android:name="com.google.android.geo.API_KEY"
///                android:value="YOUR KEY HERE"/>
class MapAMap extends Map {
  const MapAMap({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Consumer<MapProvider>(builder: (context, mapProvider, child) {
      final impl = mapProvider.impl as AmapImpl;
      return mapProvider.latlng.isEmpty
          ? Container(color: Colors.grey[300])
          : AMapWidget(
              markers: impl._markers,
              onMapCreated: (AMapController controller) {
                impl._controller = controller;
              },
              initialCameraPosition: CameraPosition(
                target: LatLng(mapProvider.latlng.lat, mapProvider.latlng.lng),
                zoom: 18,
              ),
            );
    });
  }
}
