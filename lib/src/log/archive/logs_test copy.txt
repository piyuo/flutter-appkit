import 'package:flutter_test/flutter_test.dart';
import 'package:libcli/src/eventbus/eventbus.dart';
import 'package:libcli/src/log/logs.dart';

import 'package:libcli/command.dart' as command;
import 'package:libcli/log.dart';
import 'package:libcli/app.dart' as config;
import 'package:mockito/mockito.dart';

class MockBuildContext extends Mock implements BuildContext {}


void main() {
  setUp(() async {
    // ignore: invalid_use_of_visible_for_testing_member
    sysService = command.MockService((ctx, act) async {
      return command.ok();
    });
  });

  group('[analytic]', () {
    test('should set time', () {
      var now = DateTime.now();
      var time = command.Timestamp.fromDateTime(now);
      expect(time.toDateTime().compareTo(now) == 0, true);
    });

    test('should log', () async {
      clearListeners();
      // ignore: invalid_use_of_visible_for_testing_member
      var curr = current();
      expect(curr.logs.length, 0);
      warning('mock warning');
      expect(curr.logs.length, 1);
      config.branch = config.BRANCH_MASTER;
      var id = await sendAnalytic(MockBuildContext());
      expect(id, isNotEmpty);
    });

    test('should error', () async {
      config.branch = config.BRANCH_MASTER;
      clearListeners();
      // ignore: invalid_use_of_visible_for_testing_member
      var curr = current();
      expect(curr.errors.length, 0);
      try {
        throw Exception('test error');
      } catch (e, s) {
        error( e, s);
      }
      expect(curr.errors.length, 1);
      var result = await sendAnalytic(MockBuildContext());
      expect(result, isNotEmpty);
    });

    test('should have no id if no logs or errors', () async {
      clearListeners();
      var id = await sendAnalytic(MockBuildContext());
      expect(id, isEmpty);
    });
  });
}
